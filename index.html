
<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  
  
  

  <title>JsTOTPAuthenticator</title>

    <link rel="canonical" href="https://codepen.io/vpelss/pen/EayojzL">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="manifest" href="./manifest.json"> 
  
  <link rel='stylesheet' href='https://cdn.simplecss.org/simple.css'>
  
<style>
body {
  margin: 2px;
}

#header {
  position: sticky;
  top: 0;
  background-color: white;
  width: 100%;
}
.codeClass {
  font-size: 2rem;
}

#theBar {
  border: solid;
  border-width: 1px;
  height: 3px;
  background-color: red;
}

.myTemplate {
  display: table;
  width: 100%;
  border: solid;
  border-width: 1px;
  margin: 5px;
  padding: 5px;
}

.leftTemplate {
  display: table-cell;
}

.rightTemplate {
  display: table-cell;
  text-align: right;
}

#error {
  white-space: pre-wrap;
  display: block;
  }
</style>

  
  
  
</head>

<body>
  <div id="header">
  <center>
    <span id="menu_icon">
      <a onclick="openMenu()" class="button">&#x2261;</a>
    </span>
    <span id="x_icon" hidden>
      <a onclick="closeMenu()" class="button">X</a>
    </span>
    &nbsp;&nbsp;&nbsp;
    <span>
      JsTOTPAuthenticator
    </span>
  </center>

  <div style="display: iiiinline;">
    <div id="theBar">
    </div>
    <span><span>Countdown: </span>
      <span id="countdown"></span>
    </span>
  </div>

</div>

<div_main_page id="main_page_component">

  <template id="theTemplate" hidden>
    <div id="${entryId}" class="myTemplate">
      <div class="leftTemplate">
        <div id="${entryName}">Loading Database</div>
        <div id="${entryCode}" class="codeClass">Loading Database</div>
      </div>
      <div class="rightTemplate">
        <a href="#" id="${entryCopyLink}">
          Copy Code
        </a>
      </div>
    </div>
  </template>

  <div id="entriesDiv">
    Waiting to load encrypted Aegis database
  </div>

</div_main_page>

<div_menu_page id="menu_page_component" hidden>

  <form>
    <center>
      <div>
        <input type="button" value="Get Aegis JSON encrypted database" onclick="GetAegisJsonFromTextbox();">
      </div>

      <div>
        <input type="button" value="Save Aegis JSON encrypted database" onclick="if(confirm('This will overwrite your current Aegis JSON encrypted database. Are you sure?')){SetAegisJsonFromTextbox();}">
      </div>

      <div>
        <input type="button" value="Export your Aegis JSON encrypted database to Clipboard" onclick="if(confirm('This will export Aegis JSON encrypted database, and comments to clipboard. Are you sure?')){ ExportAll(); alert('Your current Aegis JSON encrypted database is on the clipboard!');}">
      </div>

      <div>
        <textarea id="JSONSave" rows="3" cols="50" placeholder="Import/Export/Backup Aegis JSON encrypted database. Save the text generated in a safe location." title="You can import/export your current  Aegis JSON encrypted database (which is saved localy). This is helful to move it to another computer or use it as a backup." class="u-full-width">
</textarea>
      </div>
    </center>
  </form>

  <center>
    <div>
      <a href="#" id="install" class="button">Install as PWA</a>
    </div>

    <div>
      Links below will open in your default browser.
    </div>

    <div>
      <a href="https://vpelss.github.io/Forever_Passwords//README.md" class="button u-full-width" target="_blank">Help/Read Me</a>
    </div>

    <div>
      <a href="https://github.com/vpelss/JsTOTPAuthenticator" target="_blank" class="button u-full-width">Github</a>
    </div>

    <div>
      <a href="https://github.com/vpelss/JsTOTPAuthenticator/blob/main/LICENSE" target="_blank" class="button">Licence</a>
    </div>

    <div>
      <a href="https://www.emogic.com/cgi/fp/backup.php" target="blank" class="button u-full-width">Doesn't work?</a>
    </div>

  </center>

</div_menu_page>

<div_menu_page id="password_page_component" hidd>

  <form>
    <center>

      <div>
        <input type="text" value="" placeholder="Password">
      </div>

      <span>
        <input type="button" value="Get Aegis JSON encrypted database" onclick="GetAegisJsonFromTextbox();">
      </span>

      <span>
        <input type="button" value="Save Aegis JSON encrypted database" onclick="if(confirm('This will overwrite your current Aegis JSON encrypted database. Are you sure?')){SetAegisJsonFromTextbox();}">
      </span>
    </center>
  </form>

</div_menu_page>

<p></p>

<div id="error"></div>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/scrypt-js/3.0.1/scrypt.js'></script>
    <script id="rendered-js" >
// the key is decrypted when needed to verify an OTP value, and re-encrypted immediately to limit exposure in the RAM to a short period of time

// no global db??

//always encrypt. However the passwork might just be no text...

//add try{} catch(err){  postError(err); }

"use strict";

let localStorageName = "JsTOTPAuthenticator";
let localStorageJSON = {};
let plaintext;
let dbGlobal = {};
let entriesGlobal = [];
let errorArray = [];
const TE = new TextEncoder();
const TD = new TextDecoder();

// START MAIN LOOP //

GetEntries();
let myInterval = setInterval(eachSecond, 1000); //start counter

async function eachSecond() {
  try {
    if (entriesGlobal.length == 0) {
      return "No entries yet";
    }
    let unixTime = Date.now() / 1000; //in seconds
    let stepNow = unixTime / 30;
    let stepInt = Math.floor(stepNow);
    let timeLeft = Math.floor(30 - 30 * (stepNow - stepInt));
    //step MUST be in string HEX
    let step = stepInt.toString(16);
    //show countdown
    var elem = document.querySelector("#theBar");
    //var elem = document.getElementById("theBar");
    let barWidth = Math.floor((100 * timeLeft) / 30);
    elem.style.width = barWidth + "%";
    document.getElementById("countdown").innerHTML = timeLeft;
    do {
      step = "0" + step;
    } while (step.length < 16);
    // step needs to be 16 characters

    // calculate and output code for each entry and place on template
    let entriesCount = 0;
    for (let entry of entriesGlobal) {
      let name = entry.name;
      let algo = entry.info.algo;
      let digits = entry.info.digits;
      let period = entry.info.period;
      let seedBase32 = entry.info.secret;
      let seed = decodeBase32toHex(seedBase32.toUpperCase()); //base32Str to HexStr
      let totp;
      try {
        totp = await hmac(seed, step, digits, algo);
      } catch (err) {
        postError(err);
      }

      document.getElementById("entryName" + entriesCount).innerHTML = name;
      document.getElementById("entryCode" + entriesCount).innerHTML = totp;
      document.getElementById(
        "entryCopyLink" + entriesCount
      ).onclick = function () {
        copytoclipboard2(totp);
      };
      entriesCount += 1;
    }
  } catch (err) {
    postError(err);
  }
}

// BUTTON FUNCTIONS //

function openMenu() {
  try {
    document.getElementById("main_page_component").style.display = "none";
    document.getElementById("menu_page_component").style.display = "block";
    document.getElementById("menu_icon").style.display = "none";
    document.getElementById("x_icon").style.display = "inline";
  } catch (err) {
    postError(err);
  }
}

function closeMenu() {
  try {
    document.getElementById("main_page_component").style.display = "block";
    document.getElementById("menu_page_component").style.display = "none";
    document.getElementById("menu_icon").style.display = "inline";
    document.getElementById("x_icon").style.display = "none";
  } catch (err) {
    postError(err);
  }
}

function GetAegisJsonFromTextbox() {
  try {
    GetLocalStorage();
    document.getElementById("JSONSave").value = JSON.stringify(
      localStorageJSON,
      null,
      "\t"
    );
  } catch (err) {
    postError(err);
  }
}

function SetAegisJsonFromTextbox() {
  try {
    if (document.getElementById("JSONSave").value == "") {
      localStorageJSON = {};
      return;
    } else {
      localStorageJSON = JSON.parse(document.getElementById("JSONSave").value);
    }
    SetLocalStorage(localStorageJSON);
    GetEntries(); //clear and rebuild
    document.getElementById("JSONSave").value =
      "*** Encrypted Aegis database imported ***"; //clear it
  } catch (err) {
    postError(err);
  }
}

function ExportAll() {
  try {
    localStorageJSON = GetLocalStorage();
    copytoclipboard2(JSON.stringify(localStorageJSON));
  } catch (err) {
    postError(err);
  }
}

// ENCRYPTION DECRYPTION HMAC FUNCTIONS //

// for references see: https://github.com/vpelss/JsTOTPAuthenticator
async function hmac(
  keyHexString,
  stepHexString16Bytes,
  returnDigits,
  hashFunctionString
) {
  let totp;
  try {
    let blockSize = 64;
    let k, msg, tempUint8Array, hashed;

    //all our input key strings should only have hex characters [0 .. F]
    msg = Uint8Array.fromHex(stepHexString16Bytes);
    k = Uint8Array.fromHex(keyHexString); //only accepts hex string lengths of even values and convertys to bytes. byte = 2 x hex

    /*
    //HMAC: instructive
    //hmac_sha https://en.wikipedia.org/wiki/HMAC

    // create our Uint8Array key to the blockSize sized
    if (k.length > blockSize) {
      tempUint8Array = new Uint8Array(blockSize); //set to block size
      hashed = await window.crypto.subtle.digest("SHA-1", k); // hash the message
      tempUint8Array.set(new Uint8Array(hashed));
      k = tempUint8Array;
    } // Keys longer than blockSize are shortened by hashing them
    // Keys shorter than blockSize are padded to blockSize by padding with zeros on the right
    if (k.length < blockSize) {
      tempUint8Array = new Uint8Array(blockSize); //set to block size
      tempUint8Array.set(k);
      k = tempUint8Array;
    }
    // k should now be blockSize

    // create ipad and opad https://datatracker.ietf.org/doc/html/rfc2104#section-2
    let okey = new Uint8Array(k);
    okey.forEach(function (myByte, myIndex, myArray) {
      myArray[myIndex] = myArray[myIndex] ^ 0x5c;
    }); //key xor 0x5c
    let ikey = new Uint8Array(k);
    ikey.forEach(function (myByte, myIndex, myArray) {
      myArray[myIndex] = myArray[myIndex] ^ 0x36;
    }); //key xor 0x36

    // now do hash(o_key_pad concatenate hash(i_key_pad concatenate msg))

    tempUint8Array = concatenateUint8arrays([ikey, msg]); // i_key_pad + msg
    hashed = await window.crypto.subtle.digest("SHA-1", tempUint8Array);
    tempUint8Array = new Uint8Array(hashed); // hash(i_key_pad concatenate msg)

    tempUint8Array = concatenateUint8arrays([okey, tempUint8Array]); //o_key_pad âˆ¥ hash(i_key_pad + msg)
    hashed = await window.crypto.subtle.digest("SHA-1", tempUint8Array);
    hashed = new Uint8Array(hashed); // hash(o_key_pad concatenate hash(i_key_pad concatenate msg))
   */

    //HMAC: simpler, but not instructive
    let cryptoKey = await window.crypto.subtle.importKey(
      "raw",
      k,
      { name: "HMAC", hash: { name: "SHA-1" } },
      1,
      ["sign", "verify"]
    );
    hashed = await window.crypto.subtle.sign("HMAC", cryptoKey, msg);
    hashed = new Uint8Array(hashed);

    //https://datatracker.ietf.org/doc/html/rfc4226#section-5.3
    let offset = hashed[hashed.length - 1] & 0xf; //last 4 bits of hashed

    //take 4 bytes at offset (minus the first bit) and use bits to create a decimal #
    let myBinary =
      ((hashed[offset] & 0x7f) << 24) | // not signed
      (hashed[offset + 1] << 16) |
      (hashed[offset + 2] << 8) |
      hashed[offset + 3];

    //take deciamal output of myBinary and reduce to returnDigits decimal characters
    // opt is the same as taking dp/myBinary taking the decimal and multiplying with dp
    let dp = 10 ** returnDigits;
    let otp = myBinary % dp;

    totp = otp.toString();
    while (totp.length < returnDigits) {
      // make sure it is returnDigits long. pad to the left
      totp = "0" + totp;
    }
    return totp;
  } catch (err) {
    postError(err);
  }
}

async function GetEntries() {
  try {
    //unencrypt Aegis JSON DB : AES CGM
    document.getElementById("error").innerHTML = ""; //clear all errors in optimism!
    localStorageJSON = GetLocalStorage(); //load database
    if (JSON.stringify(localStorageJSON) == "{}") {
      //empty db
      entriesDiv.innerHTML = "";
      //postError("No local database");
      throw { name: "No local database", message: "No local database" };
      return;
    }
    let entriesJSON = await unencryptDB("VincePelss");
    if (entriesJSON == "") {
      throw { name: "unencryptDB failed", message: "unencryptDB failed" };
      //return;
    }
    dbGlobal = JSON.parse(entriesJSON);
    entriesGlobal = dbGlobal.entries;
    entriesJSON = ""; //data no longer needed
    BuildEntriesDOM(); //this has to be here as we need to wait for the promise
  } catch (err) {
    postError(err);
  }
}

async function unencryptDB(password) {
  try {
    password = password.normalize("NFKC");
    password = TE.encode(password);

    // based on https://github.com/Sammy-T/avdu/blob/master/vault/decrypt.go
    // FindMasterKey uses the password to decrypt the master key
    // from the vault and returns the master key's bytes.

    // go salt, err := hex.DecodeString(slot.Salt)
    let saltString = localStorageJSON.header.slots[0].salt;
    let salt = Uint8Array.fromHex(saltString);

    // Create a key using the slot values and provided password
    // go key, err = scrypt.Key([]byte(pwd), salt, slot.N, slot.R, slot.P, 32)
    let n = localStorageJSON.header.slots[0].n;
    let r = localStorageJSON.header.slots[0].r;
    let p = localStorageJSON.header.slots[0].p;
    let dkLen = 32;

    // scrypt is password based key derivation
    //from https://cdnjs.cloudflare.com/ajax/libs/scrypt-js/3.0.1/scrypt.js
    //https://github.com/ricmoo/scrypt-js?utm_source=cdnjs&utm_medium=cdnjs_link&utm_campaign=cdnjs_library#readme
    //let keyScrypt = scrypt.syncScrypt(pw, salt, n, r, p, dkLen); //syncronous
    let keyScrypt = await scrypt.scrypt(password, salt, n, r, p, dkLen); //asyncronous
    password = ""; // no longer needed

    //go nonce, err := hex.DecodeString(slot.KeyParams.Nonce)
    let nonceString = localStorageJSON.header.slots[0].key_params.nonce;
    nonceString = nonceString.normalize("NFKC");
    let nonce = Uint8Array.fromHex(nonceString);

    // go	tag, err := hex.DecodeString(slot.KeyParams.Tag)
    let tagString = localStorageJSON.header.slots[0].key_params.tag;
    let tag = Uint8Array.fromHex(tagString);

    // go slotKey, err := hex.DecodeString(slot.Key)
    let slotKeyString = localStorageJSON.header.slots[0].key;
    let slotKey = Uint8Array.fromHex(slotKeyString);

    // go var keyData []byte = append(slotKey, tag...)
    let keyData = concatenateUint8arrays([slotKey, tag]);

    // Attempt to decrypt the master key
    // go	block, err := aes.NewCipher(key)
    // go aesgcm, err := cipher.NewGCM(block)
    //go masterKey, err = aesgcm.Open(nil, nonce, keyData, nil)
    let masterKey = await decrypt(nonce, keyScrypt, keyData);

    // go nonce, err := hex.DecodeString(params.Nonce)
    nonceString = localStorageJSON.header.params.nonce;
    nonceString = nonceString.normalize("NFKC");
    nonce = Uint8Array.fromHex(nonceString);

    // go tag, err := hex.DecodeString(params.Tag)
    tagString = localStorageJSON.header.params.tag;
    tag = Uint8Array.fromHex(tagString);

    //go dbData, err := base64.StdEncoding.DecodeString(db)
    let db = localStorageJSON.db;
    let dbData = Uint8Array.fromBase64(db);

    //go var database []byte = append(dbData, tag...)
    let database = concatenateUint8arrays([dbData, tag]);

    // go block, err := aes.NewCipher(masterKey)
    // go aesgcm, err := cipher.NewGCM(block)
    // go content, err := aesgcm.Open(nil, nonce, database, nil)
    let content = await decrypt(nonce, masterKey, database);

    let unencrypted = TD.decode(content);
    return unencrypted;
  } catch (err) {
    postError(err);
  }
}

async function decrypt(iv, key, ciphertext) {
  let decrypted;
  try {
    let block = await window.crypto.subtle.importKey(
      "raw",
      key,
      { name: "AES-GCM" },
      1,
      ["encrypt", "decrypt"]
    );
    decrypted = await window.crypto.subtle.decrypt(
      { name: "AES-GCM", iv },
      block,
      ciphertext
    );
    return decrypted;
  } catch (err) {
    postError(err);
    //postError("Possible corrupt database or password is wrong<br>" + error);
  }
}

// SUPPORT FUNCTIONS //

function BuildEntriesDOM() {
  try {
    let entriesCount = 0;
    let entriesDiv = document.querySelector("#entriesDiv");
    entriesDiv.innerHTML = "";
    entriesGlobal.forEach(function (entry) {
      //replace template values
      // https://stackoverflow.com/questions/377961/efficient-javascript-string-replacement
      //https://stackoverflow.com/questions/68970312/how-do-i-resolve-a-javascript-template-literal-variable-within-a-string-within-a
      let modifiedTemplate = template("theTemplate", {
        entryId: "entryId" + entriesCount,
        entryName: "entryName" + entriesCount,
        entryCode: "entryCode" + entriesCount,
        entryCopyLink: "entryCopyLink" + entriesCount
      });
      //add to #entriesDiv
      const toAppend = document.createElement("div");
      toAppend.innerHTML = modifiedTemplate;

      entriesDiv.append(toAppend);
      entriesCount += 1;
    });
  } catch (err) {
    postError(err);
  }
}

function SetLocalStorage(json) {
  try {
    let AliasListString = JSON.stringify(json);
    if (supports_html5_storage()) {
      localStorage[localStorageName] = AliasListString;
    }
  } catch (err) {
    postError(err);
  }
}

function GetLocalStorage() {
  try {
    if (supports_html5_storage()) {
      if (localStorage[localStorageName] == "undefined") {
        return {};
      } //nothing to restore
      else {
        return JSON.parse(localStorage[localStorageName]);
      }
    } else {
      throw {
        name: "HTML5 Storage is not supported",
        message: "HTML5 Storage is not supported"
      };
    }
  } catch (err) {
    postError(err);
  }
}

function supports_html5_storage() {
  try {
    return "localStorage" in window && window.localStorage !== null;
    //return false;
  } catch (err) {
    postError(err);
    //return false;
  }
}

function copytoclipboard2(text) {
  try {
    let textarea = document.createElement("TEXTAREA");
    document.body.appendChild(textarea);
    textarea.innerHTML = text;
    textarea.value = text;
    textarea.select();
    document.execCommand("copy", false, null);
    textarea.remove();
  } catch (err) {
    postError(err);
  }
}

// modified https://medium.com/@at.kishor.k/demystifying-base32-an-in-depth-guide-to-this-encoding-standard-697b9426fc25
function decodeBase32toHex(data) {
  try {
    const BASE32_ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
    const HEX_ALPHABET = "0123456789ABCDEF";
    data = data.replace(/=/g, ""); //remove padding
    let binaryString = "";
    for (let i = 0; i < data.length; i++) {
      binaryString += BASE32_ALPHABET.indexOf(data[i])
        .toString(2)
        .padStart(5, "0");
    }
    let padding = binaryString.length % 8; //needs to be 8 as we want padding to account for bytes
    if (padding !== 0) {
      binaryString = binaryString.slice(0, -padding);
    }
    let decoded = "";
    for (let i = 0; i < binaryString.length; i += 4) {
      let decimalEquivilant = parseInt(binaryString.slice(i, i + 4), 2);
      decoded += HEX_ALPHABET[decimalEquivilant];
      //decoded += parseInt(binaryString.slice(i, i + 4), 2).toString(16).toUpperCase();
    }
    return decoded;
  } catch (err) {
    postError(err);
  }
}

// https://evanhahn.com/the-best-way-to-concatenate-uint8arrays/
function concatenateUint8arrays(uint8arrays) {
  try {
    // Determine the length of the result.
    const totalLength = uint8arrays.reduce(
      (total, uint8array) => total + uint8array.byteLength,
      0
    );
    // Allocate the result.
    const result = new Uint8Array(totalLength);
    // Copy each Uint8Array into the result.
    let offset = 0;
    uint8arrays.forEach((uint8array) => {
      result.set(uint8array, offset);
      offset += uint8array.byteLength;
    });
    return result;
  } catch (err) {
    postError(err);
  }
}

function template(templateid, data) {
  try {
    return document.getElementById(templateid).innerHTML.replace(
      ///%(\w*)%/g, // or /{(\w*)}/g for "{this} instead of %this%"
      /\${(\w*)}/g, // or  for "{this} instead of %this%"
      function (m, key) {
        return data.hasOwnProperty(key) ? data[key] : "";
      }
    );
  } catch (err) {
    postError(err);
  }
}

function postError(err) {
  errorArray.push({ Name: err.name, Message: err.message, Stack: err.stack });
  let errorString = JSON.stringify(errorArray, null, 4);
  document.getElementById("error").innerHTML = "Errors:<br>" + errorString;
}
  </script>

  
</body>

</html>
